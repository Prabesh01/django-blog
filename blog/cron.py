# python manage.py runcrons

from django_cron import CronJobBase, Schedule
import requests
from .models import Post
from django.contrib.auth.models import User
import json
from bs4 import BeautifulSoup
import re


hpen = "https://www.hamropatro.com/news"

lis={'bbc.com': ['बीबीसी नेपाली', '1f97b4c9-232e-4869-b7ab-7388d081c302.jpeg'], 'onlinekhabar.com': ['अनलाइन खबर', '7c2c1dd9-54e2-4d0d-8f58-4131bc60cf93.jpg'], 'ratopati.com': ['रातोपाटी', 'b527a188-83a4-4b25-9bc0-b0ac2bf1bb2e.jpg'], 'annapurnapost.com': ['अन्नपूर्ण पोस्ट', '0c2bbad9-1088-47b3-866c-2759e9284eb9.jpg'], 'khabarhub.com': ['खबरहब', 'da72836b-f0f6-40f4-84d9-0bc8ac82e26b.jpg'], 'lokaantar.com': ['लोकान्तर', '499a7167-531e-4cb3-9048-c34229113937.jpg'], 'baahrakhari.com': ['बाह्रखरी', '4456a44e-4b99-4b10-a4cf-f0990c01e44f.jpg'], 'setopati.com': ['सेतोपाटी', '9508bb6d-17cd-4692-8e0c-b11b85c9f7dd.jpg'], 'Ujyaaloonline.com': ['उज्यालो अनलाइन', '307f45b9-604b-4ce3-ad5e-5a43bdecb534.jpg'], 'himalkhabar.com': ['हिमालखबर', 'ae8cac86-0758-49d9-9254-983ca59e05b4.jpg'], 'ekagaj.com': ['इकागज', '627c6064-e815-47a2-bd9a-13f29563116d.jpg'], 'news24nepal.tv': ['न्युज 24', 'f8cf3739-4b72-4f70-8d27-5cf8b834b002.jpg'], 'newsofnepal.com': ['नेपाल समाचारपत्र', 'e762f7e9-3494-471c-8b14-bfdcd4e40e2d.jpg'], 'mysansar.com': ['मेरो संसार', '28ea2504-3563-40b0-b67a-61f6752831fa.jpg'], 'nepallive.com': ['नेपाल लाईभ', '5ba66902-1e4c-46eb-8783-c8d6432bef77.jpg'], 'deshsanchar.com': ['देश सञ्चार', 'ddf544fc-effe-41eb-b920-a75e2927e9f3.jpg'], 'bizmandu.com': ['बिजमाण्डू', '68bfad8d-5742-40f9-8970-fa015061da77.png'], 'karobardaily.com': ['कारोबार', 'b80c98f6-3107-4f44-a3a4-4ecbb44d3e30.jpg'], 'pahilopost.com': ['पहिलो पोस्ट', '1a0aa3f6-0c64-491c-8152-357f6d02d151.png'], 'abhiyandaily.com': ['आर्थिक अभियान', '66226212-8758-4db1-9a5b-da5b03264c86.jpg'], 'nepalipaisa.com': ['नेपाली पैसा', '78360e3d-6964-4679-a17a-449b137e695c.jpg'], 'swasthyakhabar.com': ['स्वास्थ्य खबरपत्रिका', '6a51f6a3-889d-447e-ac39-539a23ba5dbf.jpg'], 'ictsamachar.com': ['आइसिटी समाचार', 'da2543fb-d5be-4bea-a0ff-0ee824290f87.jpg'], 'reportersnepal.com': ['रिपोर्टर्स नेपाल', '2de371c4-7a8e-4feb-9e57-99cfdf598883.jpg'], 'rajdhanidaily.com': ['राजधानी', '7db43b2f-bc6c-4fe4-9746-65118f6c9e30.png'], 'thahakhabar.com': ['थाहा खबर', 'd83f5628-350b-4d93-9504-9b0ffcc53063.png'], 'imagekhabar.com': ['इमेज खबर', 'edc58a6f-cf62-4366-a775-98a86c676d4a.jpg'], 'ajakoartha.com': ['आजको अर्थ', '9e5b88a3-77a1-423d-9fdb-3c70afa9b058.jpg'], 'saralpatrika.com': ['सरल पत्रिका', 'b32c14cb-44b1-4650-a726-72ce110672ee.jpg'], 'nepalkhabar.com': ['नेपाल खबर', '170b8370-d5a9-4ba1-8fcb-22d0d9a2bce2.jpg'], 'english.ratopati.com': ['रातोपाटी | अंग्रेजी', '42e2fce2-f986-48da-a51a-736d3fd57175.jpg'], 'nepalipatra.com': ['नेपालीपत्र', 'fbf33ef4-4acd-490f-bad6-5d09047c4c4d.jpg'], 'hamrakura.com': ['हाम्रा कुरा', 'bb6b1e37-2e5c-41f7-9f02-07beeb4cb141.jpg'], 'kendrabindu.com': ['केन्द्रविन्दु', 'c2979d3c-1a6c-457e-ae00-5100922a3e5b.jpg'], 'farakdhar.com': ['फरक धार', '550ee347-4bbb-4f5b-8ae6-c493cd80e8b1.jpg'], 'aarthiknews.com': ['आर्थिक न्यूज', '3807676b-cd9a-4607-85ce-a606e4c38933.jpg'], 'techlekh.com': ['टेकलेख', 'd0f1f46c-dc01-4a6e-a009-e2f39834b638.jpg'], 'hamrokhelkud.com': ['हाम्रो खेलकुद', 'ccede223-e60e-47f6-820f-169dd808b2e3.jpg'], 'kathmandupress.com': ['काठमाडौं प्रेस', '11aabbd0-7811-45f4-b6ae-24d37c230b69.jpg'], 'nepalghatana.com': ['नेपाल घटना', '953c163d-d388-4e34-8152-e43138431f91.png'], 'english.khabarhub.com': ['खबरहब | अंग्रेजी', '8bfaaa15-e188-459e-b678-7d24b32a17f9.jpg'], 'sutranews.com': ['सुत्र न्यूज', 'fcbef5ca-ff83-4d6b-b931-e518d5ee653e.jpg'], 'palikakhabar.com': ['पालिका खबर', '9cf8b450-0807-4998-950b-ab2967fab9e4.jpg'], 'aakarpost.com': ['आकार पोस्ट', '525e9da1-2257-450d-a4df-1a6c36b2e94e.jpg'], 'halokhabar.com': ['हलोखबर', '9b5bb96d-9ab2-4edc-b340-43d6d79600d6.jpg'], 'en.reportersnepal.com': ['रिपोर्टर्स नेपाल | अंग्रेजी', '537e79e7-12f6-408f-82ab-93d425e26808.jpg'], 'shilapatra.com': ['शिलापत्र', '9aafe6e4-0026-4b87-b382-1d1e293b398e.jpg'], 'kalakarmi.com': ['कलाकर्मी', '232122c3-4025-42ff-a4a3-bd7b60b62c08.jpg'], 'merolifestyle.com': ['मेरो लाइफस्टाइल', '236b9665-fc17-4a22-9fd4-110f1d7afb26.jpg'], 'nepalhomes.com': ['नेपालहोम्स', '13767a7f-040c-4786-bc5b-b02a8eed58f8.png'], 'newspolar.com': ['न्यूजपोलार', '37c85ba1-432c-4b52-87e4-9436ace631b7.jpg'], 'dekhapadhi.com': ['देखापढी', '2ffafb2f-086c-47b9-bb9e-26ede4e79337.jpg'], 'nepaltvonline.com': ['नेपाल टेलिभिजन', '56319f2b-0956-408d-a289-0f1e2c5a0d78.jpg'], 'arthasarokar.com': ['अर्थ सरोकार', '62e5aa21-661b-45d4-96bb-e34e90c7ed28.png'], 'arthasansar.com': ['अर्थ संसार', '94c0d237-17f0-45bc-a6e7-f92a6bf2ccd3.jpg'], 'mahendranagarpost.com': ['महेन्द्रनगर पोष्ट', '9c1e59b3-530c-4730-a7a2-453363e55a68.jpeg'], 'kathmandupati.com': ['काठमाण्डौपाटी', '23a6652f-a652-40ea-8f59-666e4c182258.jpg'], 'corporatenepal.com': ['कर्पोरेट नेपाल', '3e52566a-373e-498f-b01f-8848ae1eb555.'], 'english.makalukhabar.com': ['मकालु खबर | अंग्रेजी', '625fb5e9-1c58-4ee8-a4d9-a0b48a52e2a5.png'], 'nayapatrikadaily.com': ['नयाँ पत्रिका', 'e0229f9f-2b64-4e48-849a-80a80c01ff4e.jpg'], 'neplays.com': ['Neplays', 'feb99801-f9bc-435b-b089-7f6c9e2f76fc.png'], 'dainikonline.com': ['दैनिक अनलाइन', '6ff5e210-8e3e-4bc3-80f2-e64c91baffd4.jpg'], 'canadanepal.com': ['क्यानडानेपाल', '6eae103f-484f-44ba-9a6e-0a05691c4061.jpg'], 'kathmandupost.com': ['The Kathmandu Post', '0f113cd3-3624-45b5-900b-6383882347c1.jpg'], 'dcnepal.com': ['डिसी नेपाल', '6fd2d9eb-e572-45af-8685-81f8499a20ef.jpg'], 'english.lokaantar.com': ['लोकान्तर | अंग्रेजी', 'aaf786c9-ea1b-4038-82e2-c2f9d4b9f9e4.jpg'], 'techpana.com': ['टेकपाना', '8d7edc90-c59d-47d3-92c5-faf6595bbbd2.jpg'], 'kharibot.com': ['खरीबोट', '1993112a-5187-4dd3-8943-353c87b29bb5.jpg'], 'emountaintv.com': ['emountaintv', 'd0b8e24f-411a-4fc0-bb76-0e72edddd494.jpg'], 'ukeraa.com': ['उकेरा', '4490c410-6d59-4496-bc0b-e7cd6161edab.jpg'], 'nepalwatch.com': ['नेपाल वाच', '5f4aa578-66e2-4aa2-b817-995f8ae53956.jpg'], 'makalukhabar.com': ['मकालु खबर', 'f599dd46-2d86-4316-b3a9-64499cfdafec.png'], 'techsathi.com': ['टेकसाथी', '0d1f4be3-8e4b-4ff6-b11a-b7d8f7d8e7df.png'], 'gadgetframe.com': ['GadgetFrame', 'fb22f190-148a-45d9-ac9b-dbaa365f176a.jpg'], 'nayapage.com': ['नयाँ पेज', 'a7712741-3b40-42c4-a8be-fe47cfe1a112.jpg'], 'nepalsamaya.com': ['नेपाल समय', 'cdc3b47e-663b-4b19-871c-ca7566580280.png'], 'ekantipur.com': ['कान्तिपुर', 'd03b4250-62f5-4cf0-893a-23031b2d029b.png'], 'nepalnews.com': ['नेपाल न्यूज', '5b4faa93-6b9a-46a5-bb8e-dd2fb77d497f.jpg'], 'nepalpress.com': ['नेपाल प्रेस', 'abab227c-aba3-48bf-b70f-cbd1f0d01125.jpg'], 'nepalbahas.com': ['नेपालबहस', '4703a02e-c45a-4a84-9c63-221248aa3496.jpeg'], 'en.setopati.com': ['सेतोपाटी | अंग्रेजी', 'f80fc475-9e28-4811-96a6-35fe6dc7c69e.jpg'], 'english.onlinekhabar.com': ['अनलाइन खबर | अंग्रेजी', '7c2c1dd9-54e2-4d0d-8f58-4131bc60cf93.jpg'], 'nepalpage.com': ['नेपाल पेज', 'b87b2029-61c6-4314-831c-42b5b065d4fd.jpg'], 'nepalviews.com': ['नेपाल भ्यूज', '8d1a551e-8d80-4603-b9e3-765c67cf53dd.png'], 'janaaastha.com': ['जन आस्था', 'd808264d-c145-476c-b78f-b75ec02aaec0.jpg'], 'lokpath.com': ['लोकपथ', 'a471c678-cb33-41ad-ac5b-fee7c8a5c714.jpg'], 'arthadabali.com': ['अर्थ-डबली', 'acab2f2e-0b8b-4626-bc8f-e9e3c7beb705.png'], 'hamropatro.com': ['Hamro Patro', 'a47db2bf-c3e3-4bde-bdb5-92f2129cc22e.png']}


class MyCronJob(CronJobBase):
    RUN_EVERY_MINS = 5 # every 5 minutes
    RETRY_AFTER_FAILURE_MINS = 1
    schedule = Schedule(run_every_mins=RUN_EVERY_MINS, retry_after_failure_mins=RETRY_AFTER_FAILURE_MINS)
    code = 'blog.my_cron_job'    # a unique code

    def do(self):
        page = requests.get(hpen, verify=False)
        soup = BeautifulSoup(page.content, "html.parser")
        timediv = soup.findAll("div", class_ = "newsInfo")
        for time_div in timediv:
            requestdate = time_div.findAll("a")
            link= re.sub('/r/','',re.search('/r/.*',requestdate[1].attrs['href']).group())

            if len(Post.objects.filter(sourcerl=link)) == 0:
                title=(time_div.a.contents[0])
                content=(time_div.find("div", class_ = "newsSummary").text)

                for auth in lis.keys():
                    if auth in link:
                        break
                author=lis[auth][0]
                post=Post(title=title,content=content,author=User.objects.filter(username=author)[0],sourcerl=link)
                post.save()   
